import React, { useState, useEffect } from 'react';
import { useNavigate, Navigate } from 'react-router-dom';
import axios from 'axios';
import {
  Box,
  Button,
  Container,
  TextField,
  Typography,
  Paper,
  Alert,
  Snackbar,
  CircularProgress,
  Divider,
  Grid,
  FormControlLabel,
  Switch,
  MenuItem,
  FormControl,
  InputLabel,
  Select
} from '@mui/material';
import { useAuth } from '../../context/AuthContext';

// API base URL with fallbacks
const API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:5000/api';

const RegisterAdmin = () => {
  // Move ALL useState and hooks to the top
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    password: '',
    confirmPassword: '',
    secretKey: '' // For first admin setup
  });
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [loading, setLoading] = useState(false);
  const [isFirstAdmin, setIsFirstAdmin] = useState(false); // Default to false, will be updated by API
  
  // Add development mode state
  const [devMode, setDevMode] = useState(false);
  const [apiEndpoint, setApiEndpoint] = useState(API_BASE_URL);
  const [apiStatus, setApiStatus] = useState({ checked: false, working: false });
  
  // Get createDevModeAdmin from context
  const { currentUser, isAdmin, registerAdmin, setupFirstAdmin, createDevModeAdmin } = useAuth();
  const navigate = useNavigate();

  // Check if this is first admin setup
  useEffect(() => {
    const checkFirstAdminSetup = async () => {
      try {
        setLoading(true);
        // Use axios for consistent error handling
        const response = await axios.get(`${API_BASE_URL}/auth/check-first-admin`);
        console.log('First admin check response:', response.data);
        setIsFirstAdmin(response.data.isFirstAdminSetup);
      } catch (error) {
        console.error("Error checking first admin setup:", error);
        // If error occurs, assume admin exists (safer default)
        setIsFirstAdmin(false);
        setError("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i thi·∫øt l·∫≠p admin. Gi·∫£ ƒë·ªãnh admin ƒë√£ t·ªìn t·∫°i.");
      } finally {
        setLoading(false);
      }
    };
    
    checkFirstAdminSetup();
  }, []);

  // Check API connectivity on mount
  useEffect(() => {
    const checkApiConnection = async () => {
      try {
        const response = await fetch(`${apiEndpoint}/health-check`, { 
          method: 'GET',
          headers: { 'Content-Type': 'application/json' },
          mode: 'no-cors' // Try no-cors mode if CORS is an issue
        });
        console.log('API health check response:', response);
        setApiStatus({ checked: true, working: true });
      } catch (error) {
        console.error('API connectivity error:', error);
        setApiStatus({ checked: true, working: false });
      }
    };
    
    checkApiConnection();
  }, [apiEndpoint]);
  
  // If user is not admin and this isn't first admin setup, redirect
  // This needs to come AFTER all hooks are declared
  if (currentUser && !isAdmin() && !isFirstAdmin) {
    return <Navigate to="/" />;
  }

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData({
      ...formData,
      [name]: value
    });
  };

  // Handle switching to development mode
  const handleDevModeChange = (event) => {
    setDevMode(event.target.checked);
  };

  // Handle API endpoint change
  const handleApiEndpointChange = (e) => {
    setApiEndpoint(e.target.value);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // Form validation
    if (!formData.name || !formData.email || !formData.password || !formData.confirmPassword) {
      setError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
      return;
    }
    
    if (formData.password !== formData.confirmPassword) {
      setError('M·∫≠t kh·∫©u kh√¥ng kh·ªõp');
      return;
    }
    
    if (formData.password.length < 6) {
      setError('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
      return;
    }
    
    try {
      setLoading(true);
      setError('');
      
      const adminData = {
        name: formData.name,
        email: formData.email,
        password: formData.password,
        role: 'admin'
      };
      
      console.log('Attempting to register admin with data:', { ...adminData, password: '***HIDDEN***' });
      console.log('isFirstAdmin:', isFirstAdmin);
      
      // Development mode - bypass API and simulate success
      if (devMode) {
        console.log('Using development mode - simulating successful admin creation');
        
        // Simulate a successful registration
        setTimeout(() => {
          setSuccess(`T√†i kho·∫£n admin "${formData.name}" ƒë√£ ƒë∆∞·ª£c t·∫°o (CH·∫æ ƒê·ªò PH√ÅT TRI·ªÇN)`);
          
          // Simulate storing a token
          localStorage.setItem('authToken', 'dev-mode-token-123456');
          localStorage.setItem('devModeAdmin', JSON.stringify({
            id: 'dev-admin-id',
            name: formData.name,
            email: formData.email,
            role: 'admin'
          }));
          
          setLoading(false);
          
          // Redirect after a delay
          setTimeout(() => {
            navigate('/admin/login');
          }, 1500);
        }, 1000);
        
        return;
      }
      
      // Regular API flow for first admin
      if (isFirstAdmin) {
        if (!formData.secretKey) {
          setError('Kh√≥a b√≠ m·∫≠t l√† b·∫Øt bu·ªôc ƒë·ªÉ thi·∫øt l·∫≠p t√†i kho·∫£n admin ƒë·∫ßu ti√™n');
          setLoading(false);
          return;
        }
        
        try {
          console.log(`Sending setup-first-admin request to: ${apiEndpoint}/auth/setup-first-admin`);
          
          // Use axios with proper error handling
          const response = await axios.post(`${apiEndpoint}/auth/setup-first-admin`, {
            ...adminData,
            secretKey: formData.secretKey
          });
          
          console.log('Setup first admin response:', response.data);
          
          if (response.data.success) {
            setSuccess('T√†i kho·∫£n admin ƒë·∫ßu ti√™n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
            
            // Store token if returned
            if (response.data.token) {
              localStorage.setItem('authToken', response.data.token);
              axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;
            }
            
            // Redirect after a delay
            setTimeout(() => {
              navigate('/admin/login');
            }, 2000);
          } else {
            throw new Error(response.data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
          }
        } catch (error) {
          console.error('Error setting up first admin:', error);
          
          if (error.response) {
            console.error('Response status:', error.response.status);
            console.error('Response data:', error.response.data);
            throw new Error(error.response.data.message || 'L·ªói thi·∫øt l·∫≠p t√†i kho·∫£n admin');
          } else {
            throw error;
          }
        }
      } else {
        // Regular admin creation by existing admin
        try {
          const token = localStorage.getItem('authToken');
          if (!token) {
            throw new Error('‚ùå B·∫†N CH∆ØA ƒêƒÇNG NH·∫¨P ADMIN!\n\nüí° H√£y b·∫•m n√∫t "ƒêƒÉng nh·∫≠p nhanh Admin" ·ªü d∆∞·ªõi form, ho·∫∑c ƒëƒÉng nh·∫≠p t·∫°i /admin/login tr∆∞·ªõc khi ƒëƒÉng k√Ω admin m·ªõi.');
          }
          
          console.log('Sending register-admin request with token:', token.substring(0, 20) + '...');
          
          const response = await axios.post(`${API_BASE_URL}/auth/register-admin`, adminData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          console.log('Register admin response:', response.data);
          
          if (response.data.success) {
            setSuccess('T√†i kho·∫£n admin m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
            
            // Clear form
            setFormData({
              name: '',
              email: '',
              password: '',
              confirmPassword: '',
              secretKey: ''
            });
          } else {
            throw new Error(response.data.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i');
          }
        } catch (error) {
          console.error('Error registering admin:', error);
          
          if (error.response) {
            console.error('Response status:', error.response.status);
            console.error('Response data:', error.response.data);
            
            if (error.response.status === 401) {
              throw new Error('‚ùå TOKEN H·∫æT H·∫†N!\n\nüí° H√£y b·∫•m n√∫t "ƒêƒÉng nh·∫≠p nhanh Admin" ƒë·ªÉ l·∫•y token m·ªõi.');
            } else if (error.response.status === 403) {
              throw new Error('‚ùå KH√îNG ƒê·ª¶ QUY·ªÄN!\n\nB·∫°n kh√¥ng c√≥ quy·ªÅn t·∫°o admin m·ªõi. C·∫ßn ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n admin.');
            } else if (error.response.status === 400) {
              throw new Error(error.response.data.message || 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
            }
          }
          
          throw new Error(error.message || 'L·ªói ƒëƒÉng k√Ω t√†i kho·∫£n admin');
        }
      }
      
      setLoading(false);
      
    } catch (err) {
      setLoading(false);
      setError(`ƒê√£ x·∫£y ra l·ªói: ${err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
      console.error('Registration error details:', err);
    }
  };

  // Create a direct admin function that bypasses API
  const handleDirectAdminCreation = async () => {
    try {
      setLoading(true);
      setError('');
      
      // Use the dev mode admin creation
      await createDevModeAdmin();
      
      setSuccess('T√†i kho·∫£n Dev Admin ƒë√£ ƒë∆∞·ª£c t·∫°o tr·ª±c ti·∫øp! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay.');
      
      setTimeout(() => {
        navigate('/admin/login');
      }, 1500);
      
    } catch (error) {
      setError('Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n Dev Admin: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  // Quick admin login function
  const handleQuickAdminLogin = async () => {
    try {
      setLoading(true);
      setError('');
      
      console.log('Attempting quick admin login...');
      
      const response = await axios.post(`${API_BASE_URL}/auth/admin-login`, {
        email: 'admin@gmail.com',
        password: 'admin123'
      });
      
      if (response.data.success && response.data.token) {
        localStorage.setItem('authToken', response.data.token);
        setSuccess('ƒêƒÉng nh·∫≠p admin th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ƒëƒÉng k√Ω admin m·ªõi.');
        
        // Refresh page to update currentUser
        window.location.reload();
      }
    } catch (error) {
      console.error('Quick login failed:', error);
      setError('ƒêƒÉng nh·∫≠p nhanh th·∫•t b·∫°i: ' + (error.response?.data?.message || error.message));
    } finally {
      setLoading(false);
    }
  };

  return (
    <Container maxWidth="md">
      <Box sx={{ mt: 8, mb: 4 }}>
        <Typography variant="h4" align="center" gutterBottom>
          {isFirstAdmin ? 'Thi·∫øt l·∫≠p t√†i kho·∫£n Admin ƒë·∫ßu ti√™n' : 'ƒêƒÉng k√Ω t√†i kho·∫£n Admin m·ªõi'}
        </Typography>
        <Typography color="textSecondary" align="center" sx={{ mb: 3 }}>
          {isFirstAdmin 
            ? 'T·∫°o t√†i kho·∫£n qu·∫£n tr·ªã vi√™n ƒë·∫ßu ti√™n cho h·ªá th·ªëng' 
            : 'Th√™m qu·∫£n tr·ªã vi√™n m·ªõi v√†o h·ªá th·ªëng (C·∫ßn ƒëƒÉng nh·∫≠p admin tr∆∞·ªõc)'}
        </Typography>
        
        {!isFirstAdmin && !currentUser && (
          <Alert severity="warning" sx={{ mb: 3 }}>
            <Typography variant="subtitle2" gutterBottom color="error">
              ‚ö†Ô∏è C·∫¶N ƒêƒÇNG NH·∫¨P ADMIN TR∆Ø·ªöC KHI ƒêƒÇNG K√ù
            </Typography>
            <Typography variant="body2" sx={{ mb: 2 }}>
              ƒê·ªÉ t·∫°o admin m·ªõi, b·∫°n ph·∫£i ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n admin hi·ªán c√≥:
            </Typography>
            <Typography variant="body2">
              üí° <strong>C√°ch nhanh nh·∫•t</strong>: B·∫•m n√∫t <strong>"ƒêƒÉng nh·∫≠p nhanh Admin"</strong> b√™n d∆∞·ªõi
            </Typography>
            <Typography variant="body2">
              üîó Ho·∫∑c ƒëƒÉng nh·∫≠p t·∫°i{' '}
              <Button 
                variant="text" 
                size="small" 
                onClick={() => navigate('/admin/login')}
                sx={{ textDecoration: 'underline' }}
              >
                /admin/login
              </Button>
            </Typography>
            <Typography variant="body2">
              üõ†Ô∏è Ho·∫∑c b·∫≠t <strong>"Ch·∫ø ƒë·ªô ph√°t tri·ªÉn"</strong> ƒë·ªÉ b·ªè qua y√™u c·∫ßu n√†y
            </Typography>
          </Alert>
        )}
      </Box>

      {/* Show backend connection status */}
      {loading && (
        <Alert severity="info" sx={{ mb: 3 }}>
          ƒêang k·∫øt n·ªëi v·ªõi m√°y ch·ªß...
        </Alert>
      )}

      {/* API Status Indicator */}
      {apiStatus.checked && !devMode && (
        <Alert severity={apiStatus.working ? "success" : "warning"} sx={{ mb: 3 }}>
          {apiStatus.working 
            ? `API ƒë√£ s·∫µn s√†ng: ${apiEndpoint}` 
            : `C·∫£nh b√°o: Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi API: ${apiEndpoint}`}
        </Alert>
      )}

      {/* Development Mode Toggle */}
      <Box sx={{ mb: 3, display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
        <FormControlLabel
          control={<Switch checked={devMode} onChange={handleDevModeChange} />}
          label="Ch·∫ø ƒë·ªô ph√°t tri·ªÉn (b·ªè qua API)"
        />
        
        {devMode && (
          <Typography variant="caption" color="text.secondary">
            Trong ch·∫ø ƒë·ªô n√†y, h·ªá th·ªëng s·∫Ω gi·∫£ l·∫≠p th√†nh c√¥ng m√† kh√¥ng g·ªçi API
          </Typography>
        )}
      </Box>

      {/* API Endpoint Selection */}
      {!devMode && (
        <FormControl fullWidth sx={{ mb: 3 }}>
          <InputLabel>ƒê·ªãa ch·ªâ API</InputLabel>
          <Select
            value={apiEndpoint}
            onChange={handleApiEndpointChange}
            label="ƒê·ªãa ch·ªâ API"
          >
            <MenuItem value="http://localhost:5000/api">localhost:5000</MenuItem>
            <MenuItem value="http://localhost:3000/api">localhost:3000</MenuItem>
            <MenuItem value="http://localhost:8000/api">localhost:8000</MenuItem>
            <MenuItem value="https://your-production-api.com/api">Production API</MenuItem>
          </Select>
        </FormControl>
      )}

      <Paper elevation={3} sx={{ p: 4 }}>
        <form onSubmit={handleSubmit}>
          <Grid container spacing={3}>
            <Grid item xs={12}>
              <TextField
                label="H·ªç t√™n"
                name="name"
                fullWidth
                value={formData.name}
                onChange={handleInputChange}
                required
              />
            </Grid>
            
            <Grid item xs={12}>
              <TextField
                label="Email"
                name="email"
                type="email"
                fullWidth
                value={formData.email}
                onChange={handleInputChange}
                required
              />
            </Grid>
            
            <Grid item xs={12} md={6}>
              <TextField
                label="M·∫≠t kh·∫©u"
                name="password"
                type="password"
                fullWidth
                value={formData.password}
                onChange={handleInputChange}
                required
                helperText="M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±"
              />
            </Grid>
            
            <Grid item xs={12} md={6}>
              <TextField
                label="X√°c nh·∫≠n m·∫≠t kh·∫©u"
                name="confirmPassword"
                type="password"
                fullWidth
                value={formData.confirmPassword}
                onChange={handleInputChange}
                required
              />
            </Grid>
            
            {isFirstAdmin && (
              <Grid item xs={12}>
                <Divider sx={{ my: 2 }} />
                <Typography variant="subtitle1" gutterBottom>
                  B·∫£o m·∫≠t b·ªï sung
                </Typography>
                <TextField
                  label="Kh√≥a b√≠ m·∫≠t"
                  name="secretKey"
                  type="password"
                  fullWidth
                  value={formData.secretKey}
                  onChange={handleInputChange}
                  required={!devMode} // Not required in dev mode
                  helperText={
                    devMode 
                      ? "B·ªè qua trong ch·∫ø ƒë·ªô ph√°t tri·ªÉn" 
                      : "Nh·∫≠p kh√≥a b√≠ m·∫≠t ƒë∆∞·ª£c cung c·∫•p (th∆∞·ªùng l√† 'admin123' ho·∫∑c ƒë∆∞·ª£c c·∫•u h√¨nh trong backend)"
                  }
                  disabled={devMode}
                />
              </Grid>
            )}
            
            <Grid item xs={12}>
              <Button
                type="submit"
                fullWidth
                variant="contained"
                size="large"
                disabled={loading}
                sx={{ mt: 2 }}
              >
                {loading ? <CircularProgress size={24} /> : 'ƒêƒÉng k√Ω Admin'}
              </Button>
            </Grid>
          </Grid>
        </form>
      </Paper>

      {/* Quick Admin Login and Dev Actions */}
      <Box sx={{ mt: 3, textAlign: 'center' }}>
        {!isFirstAdmin && !currentUser && (
          <Alert severity="info" sx={{ mb: 2, textAlign: 'left' }}>
            <Typography variant="subtitle2" gutterBottom>
              üéØ <strong>GI·∫¢I PH√ÅP CHO L·ªñI ƒêƒÇNG K√ù ADMIN:</strong>
            </Typography>
            <Typography variant="body2">
              1. B·∫•m n√∫t <strong>"ƒêƒÉng nh·∫≠p nhanh Admin"</strong> b√™n d∆∞·ªõi
            </Typography>
            <Typography variant="body2">
              2. Sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng, ƒëi·ªÅn form v√† b·∫•m "ƒêƒÉng k√Ω Admin"
            </Typography>
          </Alert>
        )}
        
        {!isFirstAdmin && !currentUser && (
          <Button
            onClick={handleQuickAdminLogin}
            variant="contained"
            color="primary"
            size="large"
            disabled={loading}
            sx={{ mt: 2, mr: 2, minWidth: 280 }}
          >
            {loading ? <CircularProgress size={20} /> : 'üöÄ ƒêƒÉng nh·∫≠p nhanh Admin (admin@gmail.com)'}
          </Button>
        )}
        
        <Button
          onClick={handleDirectAdminCreation}
          variant="outlined"
          color="warning"
          size="large"
          disabled={loading}
          sx={{ mt: 2, minWidth: 280 }}
        >
          {loading ? <CircularProgress size={20} /> : 'üõ†Ô∏è T·∫°o Dev Admin (B·ªè qua API)'}
        </Button>
      </Box>

      {/* Error message */}
      <Snackbar
        open={!!error}
        autoHideDuration={6000}
        onClose={() => setError('')}
        anchorOrigin={{ vertical: 'top', horizontal: 'right' }}
      >
        <Alert severity="error" onClose={() => setError('')}>
          {error}
        </Alert>
      </Snackbar>
      
      {/* Success message */}
      <Snackbar
        open={!!success}
        autoHideDuration={6000}
        onClose={() => setSuccess('')}
        anchorOrigin={{ vertical: 'top', horizontal: 'right' }}
      >
        <Alert severity="success" onClose={() => setSuccess('')}>
          {success}
        </Alert>
      </Snackbar>

      {/* Display connection information in development mode */}
      {process.env.NODE_ENV === 'development' && (
        <Box sx={{ mt: 3, p: 2, bgcolor: '#f5f5f5', borderRadius: 1 }}>
          <Typography variant="subtitle2" gutterBottom>
            Th√¥ng tin k·∫øt n·ªëi API:
          </Typography>
          <Typography variant="body2">API URL: {apiEndpoint}</Typography>
          <Typography variant="body2" color={apiStatus.working ? "success.main" : "error.main"}>
            Tr·∫°ng th√°i: {apiStatus.working ? "K·∫øt n·ªëi OK" : "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c"}
          </Typography>
          <Typography variant="caption" sx={{ display: 'block', mt: 1 }}>
            M·∫πo: ƒê·∫£m b·∫£o r·∫±ng m√°y ch·ªß backend c·ªßa b·∫°n ƒëang ch·∫°y v√† API endpoint ch√≠nh x√°c.
          </Typography>
        </Box>
      )}
    </Container>
  );
};

export default RegisterAdmin;
